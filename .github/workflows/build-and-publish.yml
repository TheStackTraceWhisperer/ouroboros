name: Build, Publish, and Deploy to GKE

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  # --- ACTION REQUIRED: Customize these variables ---
  GCP_PROJECT_ID: samuelhyman
  GCP_REGION: us-central1 # e.g., us-central1
  GKE_CLUSTER_NAME: ouroboros-cluster # The name of your GKE Autopilot cluster
  # --- End of required customizations ---
  
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

permissions:
  contents: 'read'
  id-token: 'write'
  packages: 'write'

jobs:
  build-and-publish-image:
    name: Build and Publish to GHCR
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GHCR
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and Push Docker Image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  deploy-to-gke:
    name: Deploy to GKE
    needs: build-and-publish-image
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: 'google-github-actions/auth@v2'
      with:
        workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
        service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

    - name: Get GKE cluster credentials
      uses: 'google-github-actions/get-gke-credentials@v2'
      with:
        cluster_name: ${{ env.GKE_CLUSTER_NAME }}
        location: ${{ env.GCP_REGION }}

    - name: Deploy to GKE
      run: |
        echo "Creating image pull secret for GHCR..."
        # This secret allows GKE to pull the container from the private GitHub Container Registry
        kubectl delete secret ghcr-secret --ignore-not-found
        kubectl create secret docker-registry ghcr-secret \
          --docker-server=${{ env.REGISTRY }} \
          --docker-username=${{ github.actor }} \
          --docker-password=${{ secrets.GITHUB_TOKEN }}

        echo "Updating deployment with new image tag..."
        # Replaces the placeholder in the manifest with the specific git SHA of this commit
        sed -i 's|ghcr.io/thestacktracewhisperer/ouroboros:latest|${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}|' k8s/deployment.yaml
        
        echo "Applying Kubernetes manifests..."
        kubectl apply -f k8s/deployment.yaml
        kubectl apply -f k8s/service.yaml

